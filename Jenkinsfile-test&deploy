pipeline {
  agent any

  environment {
    APP_NAME = "cyber4aprojecttest"
    DOCKER_USER = "theogrlp4a"
    DOCKER_PASS = credentials('docker-hub-credentials') // Utiliser Jenkins credentials store
    IMAGE_NAME = "${DOCKER_USER}/${APP_NAME}"
    IMAGE_TAG = "latest"
    GITHUB_REPO = "https://github.com/votre-utilisateur/votre-repo.git"
  }

  stages {
    stage('Clone Repository') {
      steps {
        git branch: 'main', url: "${GITHUB_REPO}"
      }
    }
    
    stage('Build Docker Image') {
      steps {
        script {
          withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', passwordVariable: 'PASS', usernameVariable: 'USER')]) {
            sh "echo $PASS | docker login --username $USER --password-stdin"
            sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
            sh "docker logout"
          }
        }
      }
    }

    stage('Scan Image with Trivy') {
      steps {
        script {
          sh "trivy image ${IMAGE_NAME}:${IMAGE_TAG} > trivy-report.txt"
        }
      }
    }
    
    stage('Archive Trivy Report') {
      steps {
        archiveArtifacts artifacts: 'trivy-report.txt', onlyIfSuccessful: true
      }
    }

    stage("Deploy Container") {
      steps {
        script {
          // Vérifier si le conteneur existe déjà et le supprimer s'il existe
          def containerExists = sh(script: "docker ps -a --format '{{.Names}}' | grep my_app_container || true", returnStdout: true).trim()
          if (containerExists) {
            sh "docker stop my_app_container"
            sh "docker rm my_app_container"
          }
          // Déployer le nouveau conteneur
          sh "docker run -d --name my_app_container -p 8081:80 ${IMAGE_NAME}:${IMAGE_TAG}"
        }
      }
    }
  }

  post {
    always {
      cleanWs()
    }
  }
}
